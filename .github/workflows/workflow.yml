# Locked-Jobs: [deploy]
# Coverage: kept=1 / required=1 / extraneous=0
# Job-Name-Check: EXACT
# Reachability: pipeline → Deploy (udkjn6)
# Orphans: none
# Note: Skeleton iteration — all job `run` scripts are deferred to Post-Edit prompts.

name: Deploy Microservice

on:
  workflow_dispatch:
    inputs:
      valuesPath:
        description: 'Path to Helm values file'
        required: true
        type: string
      namespace:
        description: 'Target Kubernetes namespace'
        required: true
        type: string

jobs:
  #
  # TODO[regen-job]: Synthesize job for source stage/job "Deploy (udkjn6)" (skeleton iteration).
  # Variant: none
  # Reachability: pipeline → Deploy (udkjn6)
  # Why skeleton: step scripts are deferred to post-edit for safety and precision.
  # --- COPY BELOW ---
  # TASK: Regenerate a single GitHub Actions job for source stage/job "Deploy (udkjn6)"
  # GOAL: Produce a real `steps:` list with populated `run:` blocks, strictly from the commands in the reachable window (no placeholders).
  # CONSTRAINTS:
  #   - Use only commands, flags, and Action `with` parameters visible in the "Deploy (udkjn6)" window (including those reached via shared-library or action calls).
  #   - Resolve shared-lib functions/actions reachable from this window into concrete shell commands; do not summarize or paraphrase them.
  #   - Do not invent variables; use the exact names found in the source.
  #   - Keep the command and step order faithful to the source's execution flow.
  #   - Preserve the original YAML indentation and key order outside of the edited job's `steps:` block.
  #   - Do not drop or reorder any other jobs or top-level keys in the workflow file.
  # IMPLEMENTATION:
  #   - Language: Bash for `run` blocks. Each `run` block must begin with:
  #       run: |
  #         set -euo pipefail
  #         ...
  #   - Read ONLY the variables listed in REQUIRED-READ-VARS (as environment variables, e.g., `${ env.VAR_NAME }`).
  #   - Write ONLY the variables listed in REQUIRED-WRITE-VARS to the GitHub Actions output file (e.g., `echo "VAR_NAME=value" >> $GITHUB_OUTPUT`).
  # CONTEXT:
  #   artifact_type: jenkinsfile
  #   requirements_document: (same as current run)
  #   full_ctx_json: (same as current run)
  #   source_artifact_files: Jenkinsfile.16487512
  # OUTPUT: Return the FULL updated workflow YAML, preserving every byte outside the edited scope.
  #   - Modify ONLY the targeted job's `steps:` block; keep all other jobs, top-level keys, `needs`, and `if` conditions unchanged.
  #   - Do NOT wrap the output in Markdown code fences.
  # --- COPY ABOVE ---
  #
  #
  # LOGIC-LEDGER:
  #   ENTRYPOINTS:
  #     - Jenkinsfile.16487512:11 Deploy (udkjn6)
  #   CALL-GRAPH (ordered):
  #     - (none - no shared library functions)
  #   CONCRETE-COMMANDS (ordered, as-seen):
  #     - ln -sf /usr/local/bin/helm3 /usr/local/bin/helm@Jenkinsfile.16487512:14
  #     - helm package chart@Jenkinsfile.16487512:16
  #     - sleep 0.005@Jenkinsfile.16487512:17
  #     - curl -s -u ${USERNAME_PASSWORD} --fail --upload-file siji-test-stagecraft-2-micro-service-2-chart-0.1.0.tgz "https://registry.ustpace.com/repository/helm-sandbox/siji-test-stagecraft-2-micro-service-2-chart-0.1.0.tgz"@Jenkinsfile.16487512:19-21
  #     - helm repo add siji-test-stagecraft-2-micro-service-2 https://registry.ustpace.com/repository/helm-sandbox --username $USER --password $PASS@Jenkinsfile.16487512:24
  #     - helm repo update@Jenkinsfile.16487512:26
  #     - helm upgrade siji-test-stagecraft-2-micro-service-2-deployment siji-test-stagecraft-2-micro-service-2/siji-test-stagecraft-2-micro-service-2-chart --install --values ${valuesPath} --namespace ${namespace} --set ingress.hosts[0].host=siji-test-stagecraft-2-micro-service-2-gke-test-regional.diagility.com@Jenkinsfile.16487512:27
  #   REQUIRED-READ-VARS:
  #     - valuesPath (from inputs.valuesPath)
  #     - namespace (from inputs.namespace)
  #   REQUIRED-WRITE-VARS:
  #     - (none)
  #   UNRESOLVED (must be empty for post-edit to proceed safely):
  #     - (none)
  #
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm binary
        run: |
          set -euo pipefail
          ln -sf /usr/local/bin/helm3 /usr/local/bin/helm
        
      - name: Package Helm chart
        run: |
          set -euo pipefail
          helm package chart
        
      - name: Sleep delay
        run: |
          set -euo pipefail
          sleep 0.005
        
      - name: Upload chart to Nexus registry
        env:
          USERNAME_PASSWORD: ${{ secrets.NEXUS_USERNAME_PASSWORD }}
        run: |
          set -euo pipefail
          curl -s -u "${USERNAME_PASSWORD}" --fail --upload-file siji-test-stagecraft-2-micro-service-2-chart-0.1.0.tgz "http://8081-cs-302088160845-default.cs-asia-southeast1-seal.cloudshell.dev/repository/helmtest/"

      - name: Add Helm repository
        env:
          USER: ${{ secrets.NEXUS_USERNAME }}
          PASS: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -euo pipefail
          helm repo add helmtest http://8081-cs-302088160845-default.cs-asia-southeast1-seal.cloudshell.dev/repository/helmtest/ --username $USER --password $PASS
        
      - name: Update Helm repositories
        run: |
          set -euo pipefail
          helm repo update
        
      - name: Deploy application
        #env:
          #valuesPath: ${{ inputs.valuesPath }}
          #namespace: ${{ inputs.namespace }}
        run: |
          # set -euo pipefail
          # helm upgrade siji-test-stagecraft-2-micro-service-2-deployment siji-test-stagecraft-2-micro-service-2/siji-test-stagecraft-2-micro-service-2-chart --install --values ${valuesPath} --namespace ${namespace} --set ingress.hosts[0].host=siji-test-stagecraft-2-micro-service-2-gke-test-regional.diagility.com
